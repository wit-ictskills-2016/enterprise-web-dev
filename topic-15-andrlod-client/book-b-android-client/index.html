 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>
        

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}



    </style>

  </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}



</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      15: Android Client
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-15: Android Client">
      Lab-15: Android Client
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="07">
      07
    </a>
    
    <a class="item" data-tab="08">
      08
    </a>
    
    <a class="item" data-tab="09">
      09
    </a>
    
    <a class="item" data-tab="Exercises">
      Exercises
    </a>
    
    <a class="item" href="../../index.html">
      <i class="home icon"></i>
    </a>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic-01-html/book-01-html/index.html">
          Lab-1.1 Html
        </a>
      
    
      
        <a class="item" href="../../topic-01-html/book-02-templates/index.html">
          Lab-1.2 Templates
        </a>
      
    
      
        <a class="item" href="../../topic-02-css/book-01-css-frameworks-1/index.html">
          Lab-2.1 Css 1
        </a>
      
    
      
        <a class="item" href="../../topic-02-css/book-02-css-frameworks-2/index.html">
          Lab-2.2 Css 2
        </a>
      
    
      
        <a class="item" href="../../topic-03-js+dom/book-1-javascript-intro/index.html">
          Lab-3.1 JS Intro
        </a>
      
    
      
        <a class="item" href="../../topic-03-js+dom/book-2-javascript-fundamentals/index.html">
          Lab-3.2 JS Basics
        </a>
      
    
      
        <a class="item" href="../../topic-03-js+dom/book-3-jquery/index.html">
          Lab-3.3 JQuery
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-1-ajax-1/index.html">
          Lab-4.1 Github API
        </a>
      
    
      
        <a class="item" href="../../topic-04-ajax+apis/book-2-ajax-2/index.html">
          Lab-4.2-FoureSquare API
        </a>
      
    
      
        <a class="item" href="../../topic-05-applications/book-applications/index.html">
          Lab-5 Applications
        </a>
      
    
      
        <a class="item" href="../../topic-06-views/book-views/index.html">
          Lab-6 Views
        </a>
      
    
      
        <a class="item" href="../../topic-07-sessions/book-sessions/index.html">
          Lab-7 Sessions
        </a>
      
    
      
        <a class="item" href="../../topic-08-models/book-models/index.html">
          Lab-8 Models
        </a>
      
    
      
        <a class="item" href="../../topic-09-validation/book-validation/index.html">
          Lab-9 Validation
        </a>
      
    
      
        <a class="item" href="../../topic-10-deployment/book-deployment/index.html">
          Lab-10 Deployment
        </a>
      
    
      
        <a class="item" href="../../topic-11-seeding/book-seeding/index.html">
          Lab-11 Seeding
        </a>
      
    
      
        <a class="active item" href="../../topic-15-andrlod-client/book-b-android-client/index.html">
          Lab-15: Android Client
        </a>
      
    
      
        <a class="item" href="../../topic-16-auth/book-auth/index.html">
          Lab-16 Auth
        </a>
      
    
      
        <a class="item" href="../../topic-17-secure-android-client/book-secure-android/index.html">
          Lab-17 Secure Android
        </a>
      
    
      
        <a class="item" href="../../topic-18-aurelia-1/book-2-aurelia-app/index.html">
          Lab-18 Aurelia 1
        </a>
      
    
      
        <a class="item" href="../../topic-19-android-service/book-android-service/index.html">
          Lab-19 Android Service
        </a>
      
    
      
        <a class="item" href="../../topic-20-aurelia-2/book-spa-2/index.html">
          Lab-20 Aurelia 2
        </a>
      
    
      
        <a class="item" href="../../topic-21-aurelia-3/book-aurelia-3/index.html">
          Lab-21 Aurelia 3
        </a>
      
    
  </div>
  <div class="pusher">
    <div class="ui basic segment">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-15: Android Client">
        <h1>Objectives</h1>
<p>Reintroduce the Donation Android app, refactor it to interact with the donation-play-service</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h1>Donation-android app</h1>
<p>This is the donation android app as we left it with Donation-03 lab:</p>
<ul>
<li><a href="https://github.com/wit-ictskills-2016/donation-android-2016">https://github.com/wit-ictskills-2016/donation-android-2016</a></li>
</ul>
<p>If you have completed the last donation android lab, then you can use your own project. If not, use the above archive.</p>
<h2>Libraries</h2>
<p>Open the Build.Gradle file - there are two, so make sure it is the one into the &#39;app&#39; folder:</p>
<pre><code>apply plugin: &#39;com.android.application&#39;

android {
  compileSdkVersion 23
  buildToolsVersion &quot;23.0.3&quot;

  defaultConfig {
    applicationId &quot;app.donation&quot;
    minSdkVersion 19
    targetSdkVersion 23
    versionCode 1
    versionName &quot;1.0&quot;
  }
  buildTypes {
    release {
      minifyEnabled false
      proguardFiles getDefaultProguardFile(&#39;proguard-android.txt&#39;), &#39;proguard-rules.pro&#39;
    }
  }
}

dependencies {
  compile fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])
  testCompile &#39;junit:junit:4.12&#39;
  compile &#39;com.android.support:appcompat-v7:23.4.0&#39;
}</code></pre>
<p>Then modify the <code>dependencies</code> section to include extra entries:</p>
<pre><code>dependencies {
  compile fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])
  testCompile &#39;junit:junit:4.12&#39;
  compile &#39;com.android.support:appcompat-v7:23.4.0&#39;
  compile &#39;com.squareup.retrofit2:retrofit:2.1.0&#39;
  compile &#39;com.google.code.gson:gson:2.7&#39;
  compile &#39;com.squareup.retrofit2:converter-gson:2.0.2&#39;
}</code></pre>
<p>Now open the <code>androidManifext.xml</code> file - and insert this new permission entry:</p>
<pre><code>    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</code></pre>
<p>This should be entered before the <code>&lt;application&gt;</code> element as shown here:</p>
<pre><code>&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    package=&quot;app.donation&quot; &gt;

    &lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;

    &lt;application
      ....
      ....
      ....
&lt;/manifest&gt;</code></pre>
<p>You may be offered the &#39;Sync Now&#39; button - press it. If not, locate it and press it (it is on the toolbar)</p>
<p>The project should sync successfully.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>Models - User &amp; Donation</h1>
<p>The current User and Donation classes need some minor adjustments. Specifically, we need to include an _id field:</p>
<h2>Donation</h2>
<pre><code>package app.donation.model;

public class Donation
{
  public String _id;
  public int    amount;
  public String method;

  public Donation (int amount, String method)
  {
    this.amount = amount;
    this.method = method;
  }
}</code></pre>
<p>We will rename User to Donor:</p>
<h2>Donor</h2>
<pre><code>package app.donation.model;

public class User
{
  public String _id;
  public String firstName;
  public String lastName;
  public String email;
  public String password;

  public User(String firstName, String lastName, String email, String password)
  {
    this.firstName = firstName;
    this.lastName = lastName;
    this.email = email;
    this.password = password;
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Proxy</h1>
<p>In main package, introduce this DonationService class</p>
<h1>DonationService</h1>
<pre><code class="lang-java">package app.donation.main;

import java.util.List;
import app.donation.model.Donation;
import app.donation.model.User;
import retrofit2.Call;
import retrofit2.http.Body;
import retrofit2.http.DELETE;
import retrofit2.http.GET;
import retrofit2.http.POST;
import retrofit2.http.Path;

public interface DonationService
{
  @GET(&quot;/api/users&quot;)
  Call&lt;List&lt;User&gt;&gt; getAllUsers();

  @GET(&quot;/api/users/{id}&quot;)
  Call&lt;User&gt; getUser(@Path(&quot;id&quot;) String id);

  @POST(&quot;/api/users&quot;)
  Call&lt;User&gt; createUser(@Body User User);

  @DELETE(&quot;/api/users/{id}&quot;)
  Call&lt;User&gt; deleteUser(@Path(&quot;id&quot;) String id);

  @DELETE(&quot;/api/users&quot;)
  Call&lt;String&gt; deleteAllUsers();

  @GET(&quot;/api/donations&quot;)
  Call&lt;List&lt;Donation&gt;&gt; getAllDonations();

  @DELETE(&quot;/api/donations&quot;)
  Call&lt;String&gt; deleteAllDonations();

  @GET(&quot;/api/users/{id}/donations&quot;)
  Call&lt;List&lt;Donation&gt;&gt; getDonations(@Path(&quot;id&quot;) String id);

  @GET(&quot;/api/users/{id}/donations/{donationId}&quot;)
  Call&lt;Donation&gt; getDonation(@Path(&quot;id&quot;) String id, @Path(&quot;donationId&quot;) String donationId);

  @POST(&quot;/api/users/{id}/donations&quot;)
  Call&lt;Donation&gt; createDonation(@Path(&quot;id&quot;) String id, @Body Donation donation);

  @DELETE(&quot;/api/users/{id}/donatinos/{donationId}&quot;)
  Call&lt;Donation&gt; deleteDonation(@Path(&quot;id&quot;) String id, @Path(&quot;donationId&quot;) String donationId);
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>DontionApp</h1>
<p>This class will require substantial additions. Here is a new version:</p>
<pre><code>package app.donation.main;

import java.util.ArrayList;
import java.util.List;

import android.app.Application;
import android.util.Log;
import android.widget.Toast;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import app.donation.model.User;
import app.donation.model.Donation;
import retrofit2.Retrofit;
import retrofit2.converter.gson.GsonConverterFactory;

public class DonationApp extends Application
{
  public DonationService donationService;
  public boolean         donationServiceAvailable = false;
  public String          service_url  = &quot;http://10.0.2.2:4000&quot;;   // Standard Emulator IP Address

  public final int       target       = 10000;
  public int             totalDonated = 0;

  public User            currentUser;
  public List &lt;Donation&gt; donations    = new ArrayList&lt;Donation&gt;();
  public List &lt;User&gt;     users        = new ArrayList&lt;User&gt;();

  public boolean newDonation(Donation donation)
  {
    boolean targetAchieved = totalDonated &gt; target;
    if (!targetAchieved)
    {
      donations.add(donation);
      totalDonated += donation.amount;
    }
    else
    {
      Toast toast = Toast.makeText(this, &quot;Target Exceeded!&quot;, Toast.LENGTH_SHORT);
      toast.show();
    }
    return targetAchieved;
  }

  @Override
  public void onCreate()
  {
    super.onCreate();
    super.onCreate();
    Gson gson = new GsonBuilder().create();

    Retrofit retrofit = new Retrofit.Builder()
        .baseUrl(service_url)
        .addConverterFactory(GsonConverterFactory.create(gson))
        .build();
    donationService = retrofit.create(DonationService.class);

    Log.v(&quot;Donate&quot;, &quot;Donation App Started&quot;);
  }

  public void newUser(User user)
  {
    users.add(user);
  }

  public boolean validUser (String email, String password)
  {
    for (User user : users)
    {
      if (user.email.equals(email) &amp;&amp; user.password.equals(password))
      {
        currentUser = user;
        return true;
      }
    }
    return false;
  }

}</code></pre>
<p>This version sets up a DonationServiceProxy object - much like the donation-service-test did, and makes this service object available for the activities. We will explore how it is used in the next few steps.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>Welcome</h1>
<p>This is a new version of the Welcome Activity class</p>
<pre><code>package app.donation.activity;

import app.donation.R;
import app.donation.activity.Login;
import app.donation.activity.Signup;
import app.donation.main.DonationApp;
import app.donation.model.User;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;

import android.content.Intent;
import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.view.View;
import android.widget.Toast;

import java.util.List;


public class Welcome extends AppCompatActivity implements Callback&lt;List&lt;User&gt;&gt;
{
  private DonationApp app;

  @Override
  public void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_welcome);

    app = (DonationApp) getApplication();
  }

  @Override
  public void onResume()
  {
    super.onResume();
    app.currentUser = null;
    Call&lt;List&lt;User&gt;&gt; call = (Call&lt;List&lt;User&gt;&gt;) app.donationService.getAllUsers();
    call.enqueue(this);
  }

  @Override
  public void onResponse(Call&lt;List&lt;User&gt;&gt; call, Response&lt;List&lt;User&gt;&gt; response)
  {
    serviceAvailableMessage();
    app.users = response.body();
    app.donationServiceAvailable = true;
  }

  @Override
  public void onFailure(Call&lt;List&lt;User&gt;&gt; call, Throwable t)
  {
    app.donationServiceAvailable = false;
    serviceUnavailableMessage();
  }

  public void loginPressed (View view)
  {
    if (app.donationServiceAvailable)
    {
      startActivity (new Intent(this, Login.class));
    }
    else
    {
      serviceUnavailableMessage();
    }
  }

  public void signupPressed (View view)
  {
    if (app.donationServiceAvailable)
    {
      startActivity (new Intent(this, Signup.class));
    }
    else
    {
      serviceUnavailableMessage();
    }
  }

  void serviceUnavailableMessage()
  {
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
  }

  void serviceAvailableMessage()
  {
    Toast toast = Toast.makeText(this, &quot;Donation Contacted Successfully&quot;, Toast.LENGTH_LONG);
    toast.show();
  }
}</code></pre>
<p>onResume is issuing a request to the API for the list of all donors...</p>
<pre><code>    Call&lt;List&lt;Donor&gt;&gt; call = (Call&lt;List&lt;Donor&gt;&gt;) app.donationService.getAllDonors();
    call.enqueue(this);</code></pre>
<p>the response to this request is delivered into one of these two methods:</p>
<pre><code>  public void onResponse(Call&lt;List&lt;User&gt;&gt; call, Response&lt;List&lt;User&gt;&gt; response)
  {
    serviceAvailableMessage();
    app.users = response.body();
    app.donationServiceAvailable = true;
  }

  @Override
  public void onFailure(Call&lt;List&lt;User&gt;&gt; call, Throwable t)
  {
    app.donationServiceAvailable = false;
    serviceUnavailableMessage();
  }</code></pre>
<p>onResponse indicates success - so we store the donors in the app objects. onFailure sets a flag in app, and displays an error message.</p>
<p>Run the app now (make sure the donation-service is running). You should get the &#39;Donation Contacted Successfully&#39; messages. If not, we will need to discover why before proceeding to next steps...</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <h1>Login</h1>

      </div>
     
      <div  class="ui tab segment lab" data-tab="07">
        <h1>Signup Activity</h1>
<p>We can rework the Signup Activity in a similar fashion:</p>
<pre><code>package app.donation.activity;

import android.content.Intent;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.View;
import android.widget.TextView;
import android.widget.Toast;

import app.donation.R;
import app.donation.main.DonationApp;
import app.donation.model.User;
import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
import retrofit2.Retrofit;

public class Signup extends AppCompatActivity implements Callback&lt;User&gt;
{
  private DonationApp app;

  @Override
  protected void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_signup);
    app = (DonationApp) getApplication();
  }

  public void signupPressed (View view)
  {
    TextView firstName = (TextView)  findViewById(R.id.firstName);
    TextView lastName  = (TextView)  findViewById(R.id.lastName);
    TextView email     = (TextView)  findViewById(R.id.Email);
    TextView password  = (TextView)  findViewById(R.id.Password);

    User user = new User(firstName.getText().toString(), lastName.getText().toString(), email.getText().toString(), password.getText().toString());

    DonationApp app = (DonationApp) getApplication();
    Call&lt;User&gt; call = (Call&lt;User&gt;) app.donationService.createUser(user);
    call.enqueue(this);
  }

  @Override
  public void onResponse(Call&lt;User&gt; call, Response&lt;User&gt; response)
  {
    app.users.add(response.body());
    startActivity(new Intent(this, Welcome.class));
  }

  @Override
  public void onFailure(Call&lt;User&gt; call, Throwable t)
  {
    app.donationServiceAvailable = false;
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
    startActivity (new Intent(this, Welcome.class));
  }
}</code></pre>
<p>Run the app now - and sign up a new user. It should work successfully. The significant changes are here:</p>
<p>We send a new donors details to the service here&quot;</p>
<pre><code>    Call&lt;Donor&gt; call = (Call&lt;Donor&gt;) app.donationService.createDonor(donor);
    call.enqueue(this);</code></pre>
<p>.. and we deal with the responses here:</p>
<pre><code>  @Override
  public void onResponse(Call&lt;User&gt; call, Response&lt;User&gt; response)
  {
    app.users.add(response.body());
    startActivity(new Intent(this, Welcome.class));
  }

  @Override
  public void onFailure(Call&lt;User&gt; call, Throwable t)
  {
    app.donationServiceAvailable = false;
    Toast toast = Toast.makeText(this, &quot;Donation Service Unavailable. Try again later&quot;, Toast.LENGTH_LONG);
    toast.show();
    startActivity (new Intent(this, Welcome.class));
  }</code></pre>
<p>To verify that is has worked, check the api for the new donor:</p>
<ul>
<li><a href="http://localhost:4000/api/users">http://localhost:4000/api/users</a></li>
</ul>
<p>If it is not working correctly at this stage - you will need to discover why before moving on to the next steps.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="08">
        <h1>Donate</h1>
<p>We will take Donate step by step this time to gain a better understanding of how the service is accessed.</p>
<p>First, in Donate Activity, bring in these imports:</p>
<pre><code>import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;
import retrofit2.Retrofit;</code></pre>
<p>The implement the following interface in the class:</p>
<pre><code>public class Donate extends AppCompatActivity implements Callback&lt;Donation&gt;</code></pre>
<p>This will cause an error - and android studio may be able to suggest fixes via the following menu:</p>
<p><img src="img/01x.png" alt=""></p>
<p>Which will generate these methods:</p>
<pre><code>  @Override
  public void onResponse(Call&lt;Donation&gt; call, Response&lt;Donation&gt; response)
  {

  }

  @Override
  public void onFailure(Call&lt;Donation&gt; call, Throwable t)
  {

  }</code></pre>
<p>We now change part of our donateButtonPressed method to make the call to the service:</p>
<pre><code>  ...
    if (donatedAmount &gt; 0)
    {
      Donation donation = new Donation(donatedAmount, method);
      Call&lt;Donation&gt; call = (Call&lt;Donation&gt;) app.donationService.createDonation(app.currentUser._id, donation);
      call.enqueue(this);
    }
  ...</code></pre>
<p>... and finally, the response/error methods can be implemented:</p>
<pre><code>  @Override
  public void onResponse(Call&lt;Donation&gt; call, Response&lt;Donation&gt; response)
  {
    Toast toast = Toast.makeText(this, &quot;Donation Accepteed&quot;, Toast.LENGTH_SHORT);
    toast.show();
    app.newDonation(response.body());
    progressBar.setProgress(app.totalDonated);
    String totalDonatedStr = &quot;$&quot; + app.totalDonated;
    amountTotal.setText(totalDonatedStr);
    amountText.setText(&quot;&quot;);
    amountPicker.setValue(0);
  }

  @Override
  public void onFailure(Call&lt;Donation&gt; call, Throwable t)
  {
    Toast toast = Toast.makeText(this, &quot;Error making donation&quot;, Toast.LENGTH_LONG);
    toast.show();
  }</code></pre>
<p>Run this now - and you should see &#39;donation accepted&#39; message.</p>
<p>Check the api to see if it is there:</p>
<ul>
<li><a href="http://localhost:9000/api/donations">http://localhost:9000/api/donations</a></li>
</ul>
<p>Also check the specific donors donations:</p>
<ul>
<li><a href="http://localhost:9000/api/donors/2/donations">http://localhost:9000/api/donors/2/donations</a></li>
</ul>
<p>(id 2 in the above)</p>
<p>Complete Version of the Donation Class at this stage:</p>
<pre><code>package app.donation.activity;

import android.content.Intent;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.RadioGroup;
import android.widget.NumberPicker;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;

import app.donation.model.Donation;
import app.donation.main.DonationApp;
import app.donation.R;

import retrofit.Call;
import retrofit.Callback;
import retrofit.Response;
import retrofit.Retrofit;

public class Donate extends AppCompatActivity implements Callback&lt;Donation&gt;
{
  private Button       donateButton;
  private RadioGroup   paymentMethod;
  private ProgressBar  progressBar;
  private NumberPicker amountPicker;
  private int          totalDonated;
  private int          target;

  private TextView     amountText;
  private TextView     amountTotal;

  private DonationApp app;

  @Override
  protected void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_donate);

    app = (DonationApp) getApplication();

    donateButton  = (Button) findViewById(R.id.donateButton);
    paymentMethod = (RadioGroup)   findViewById(R.id.paymentMethod);
    progressBar   = (ProgressBar)  findViewById(R.id.progressBar);
    amountPicker  = (NumberPicker) findViewById(R.id.amountPicker);
    amountTotal   = (TextView)     findViewById(R.id.amountTotal);
    amountText    = (EditText)     findViewById(R.id.amountText);

    amountPicker.setMinValue(0);
    amountPicker.setMaxValue(1000);
    progressBar.setMax(10000);

    totalDonated = 0;
    target = 10000;

  }

  @Override
  public boolean onCreateOptionsMenu(Menu menu)
  {
    // Inflate the menu; this adds items to the action bar if it is present.
    getMenuInflater().inflate(R.menu.menu_donate, menu);
    return true;
  }


  public void donateButtonPressed (View view)
  {
    String method = paymentMethod.getCheckedRadioButtonId() == R.id.PayPal ? &quot;PayPal&quot; : &quot;Direct&quot;;
    int donatedAmount =  amountPicker.getValue();
    if (donatedAmount == 0)
    {
      String text = amountText.getText().toString();
      if (!text.equals(&quot;&quot;))
        donatedAmount = Integer.parseInt(text);
    }
    if (donatedAmount &gt; 0)
    {
      Donation donation = new Donation(donatedAmount, method);
      Call&lt;Donation&gt; call = (Call&lt;Donation&gt;) app.donationService.createDonation(app.currentUser.id, donation);
      call.enqueue(this);
    }
    amountText.setText(&quot;&quot;);
    amountPicker.setValue(0);
  }

  @Override
  public boolean onOptionsItemSelected(MenuItem item)
  {
    switch (item.getItemId())
    {
      case R.id.menuReport : startActivity (new Intent(this, Report.class));
        break;
      case R.id.menuLogout : startActivity (new Intent(this, Welcome.class));
        break;
    }
    return true;
  }

  @Override
  public void onResponse(Response&lt;Donation&gt; response, Retrofit retrofit)
  {
    Toast toast = Toast.makeText(this, &quot;Donation Accepteed&quot;, Toast.LENGTH_SHORT);
    toast.show();
    app.newDonation(response.body());
    progressBar.setProgress(app.totalDonated);
    String totalDonatedStr = &quot;$&quot; + app.totalDonated;
    amountTotal.setText(totalDonatedStr);
    amountText.setText(&quot;&quot;);
    amountPicker.setValue(0);
  }

  @Override
  public void onFailure(Throwable t)
  {
    Toast toast = Toast.makeText(this, &quot;Error making donation&quot;, Toast.LENGTH_LONG);
    toast.show();
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="09">
        <h1>Report</h1>
<p>Try the report now before making any changes.</p>
<p>You will notice that it seems to list the donations. Where are these coming from? We havent made any changes to the Report activity yet...</p>
<p>We can now adjust this - and have the report display ALL donations (not just the donations made on this device).</p>
<p>Before we start, make the following changes to the Report class:</p>
<p>Introduce a new private member:</p>
<pre><code>  private DonationAdapter adapter;</code></pre>
<p>.. and change the onCreate method to initialise this member:</p>
<pre><code>  public void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_report);

    app = (DonationApp) getApplication();

    listView = (ListView) findViewById(R.id.reportList);
    adapter = new DonationAdapter (this, app.donations);
    listView.setAdapter(adapter);
  }</code></pre>
<p>(we are just making the adapter a class member, previously it was local)</p>
<p>Now, import the libraries we need:</p>
<pre><code>import android.widget.Toast;
import retrofit.Call;
import retrofit.Callback;
import retrofit.Response;
import retrofit.Retrofit;</code></pre>
<p>Then implement the callback:</p>
<pre><code>public class Report extends AppCompatActivity implements Callback&lt;Donation&gt;</code></pre>
<p>... and these are the required method overrides:</p>
<pre><code>  @Override
  public void onResponse(Response&lt;List&lt;Donation&gt;&gt; response, Retrofit retrofit)
  {
    adapter.donations = response.body();
    adapter.notifyDataSetChanged();
  }

  @Override
  public void onFailure(Throwable t)
  {
    Toast toast = Toast.makeText(this, &quot;Error retrieving donations&quot;, Toast.LENGTH_LONG);
    toast.show();
  }</code></pre>
<p>and finally, in onCreate - make the call to retrieve the donations:</p>
<pre><code>    Call&lt;List&lt;Donation&gt;&gt; call = (Call&lt;List&lt;Donation&gt;&gt;) app.donationService.getAllDonations();
    call.enqueue(this);</code></pre>
<p>Try this now - you should see a list of all dontations.</p>
<p>Complete version of Report class at this stage:</p>
<pre><code>package app.donation.activity;

import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.support.v7.app.AppCompatActivity;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.TextView;

import java.util.List;

import app.donation.main.DonationApp;
import app.donation.R;
import app.donation.model.Donation;

import android.widget.Toast;
import retrofit.Call;
import retrofit.Callback;
import retrofit.Response;
import retrofit.Retrofit;

public class Report extends AppCompatActivity implements Callback&lt;List&lt;Donation&gt;&gt;
{
  private ListView        listView;
  private DonationApp     app;
  private DonationAdapter adapter;

  @Override
  public void onCreate(Bundle savedInstanceState)
  {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_report);

    app = (DonationApp) getApplication();

    listView = (ListView) findViewById(R.id.reportList);
    adapter = new DonationAdapter (this, app.donations);
    listView.setAdapter(adapter);

    Call&lt;List&lt;Donation&gt;&gt; call = (Call&lt;List&lt;Donation&gt;&gt;) app.donationService.getAllDonations();
    call.enqueue(this);
  }

  @Override
  public boolean onCreateOptionsMenu(Menu menu)
  {
    getMenuInflater().inflate(R.menu.menu_report, menu);
    return true;
  }

  @Override
  public boolean onOptionsItemSelected(MenuItem item)
  {
    switch (item.getItemId())
    {
      case R.id.menuDonate : startActivity (new Intent(this, Donate.class));
        break;
      case R.id.menuLogout : startActivity (new Intent(this, Welcome.class));
        break;
    }
    return true;
  }

  @Override
  public void onResponse(Response&lt;List&lt;Donation&gt;&gt; response, Retrofit retrofit)
  {
    adapter.donations = response.body();
    adapter.notifyDataSetChanged();
  }

  @Override
  public void onFailure(Throwable t)
  {
    Toast toast = Toast.makeText(this, &quot;Error retrieving donations&quot;, Toast.LENGTH_LONG);
    toast.show();
  }
}

class DonationAdapter extends ArrayAdapter&lt;Donation&gt;
{
  private Context context;
  public List&lt;Donation&gt; donations;

  public DonationAdapter(Context context, List&lt;Donation&gt; donations)
  {
    super(context, R.layout.row_layout, donations);
    this.context   = context;
    this.donations = donations;
  }

  @Override
  public View getView(int position, View convertView, ViewGroup parent)
  {
    LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);

    View     view       = inflater.inflate(R.layout.row_layout, parent, false);
    Donation donation   = donations.get(position);
    TextView amountView = (TextView) view.findViewById(R.id.row_amount);
    TextView methodView = (TextView) view.findViewById(R.id.row_method);

    amountView.setText(&quot;&quot; + donation.amount);
    methodView.setText(donation.method);

    return view;
  }

  @Override
  public int getCount()
  {
    return donations.size();
  }
}</code></pre>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Exercises">
        <h1>Exercises</h1>
<p>Archive of project so far:</p>
<ul>
<li><a href="https://github.com/wit-computing/donation-android-2015-03/releases/tag/V04">https://github.com/wit-computing/donation-android-2015-03/releases/tag/V04</a></li>
</ul>
<h2>Exercise 1: Heroku</h2>
<p>Test the android application against the the heroku deployed service.</p>
<p>You will need to insert the appropriate url into the DonationApp:</p>
<pre><code>  public String               service_url  = &quot;http://10.0.2.2:9000&quot;;   // Standard Emulator IP Address</code></pre>

      </div>
     
    </div>
  </div>
</div>
  <div class="ui bottom fixed borderless right menu">
    <div class="ui right tiny menu">
      <div class="ui mini message segment">
        <a href="mailto://edeleastar@wit.ie"> Eamonn de Leastar <a>.
        <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
            target="_blank">Creative Commons License
        </a>
      </div>
    </div>
  </div>

    <footer>

    </footer>
    <script>
      
$(document).ready(function()
{
  $("img").addClass ("ui image");
  $('.ui.embed').embed();

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });


  $('.ui.menu .item')
      .tab({
        history: true,
        historyType: 'hash',
      });

  $('.popup').popup();

  $('.ui.sidebar')
      .sidebar({ context: $('.pushable') })
      .sidebar('setting', 'transition', 'slide out')
      .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>